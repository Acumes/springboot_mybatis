<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.htf.mapper.SkuBomMapper">
    <!--开启二级缓存-->
    <cache type="org.mybatis.caches.ehcache.EhcacheCache"/>
        <!--根据id查询用户详情-->
    <resultMap id="skuBomResult" type="com.htf.entity.SkuBom" autoMapping="true" >
        <association property="bomSku" javaType="com.htf.entity.Sku"
                     autoMapping="true" >
        </association>
    </resultMap>
    <sql id="Base_Column_List" >
            sku_code as skuCode,
			name as name,
            status as status,
			bom_status as bomStatus,
			measure_unit_id as `measureUnit.measureunitCode`,
			piffer as piffer,
			verify as verify,
			IF(verify = 1, "已审核", "未审核") verifySearch,
			VERIFIER as verifier,
			VERIFY_NAME as verifyName,
			VERIFY_TIME as verifyTime,
			has_bom_status as hasBom,
			IF(has_bom_status = 1, "是", "否") hasBomSearch,
			pictures as pictures,
			comment as comment,
			create_time as createTime,
			creator as creatorId
    </sql>

    <sql id="baseSelect">
        sb.sku_code AS skuCode,
		sb.bom_sku_code AS `bomSku.skuCode`,
		bom_sku.NAME AS `bomSku.name`,
		bom_sku.piffer AS `bomSku.piffer`,
		bom_sku.NAME AS `bomSku.name`,
		bom_sku.HAS_BOM_STATUS AS `bomSku.hasBom`,
		sb.qty AS qty,
		sb.qty_denominator AS qtyDenominator,
		sb.WASTE_RATE AS wasteRate,
		sb.is_deleted_record AS isDeletedRecord,
		sb.COMMENT AS COMMENT,
		sb.sku_version AS skuVersion,
		sb.CREATE_DATE AS crtTime,
		sb.creator AS creatorId,
		pui_crt.nick_name AS creatorName
	    FROM
		 sku_bom sb
		LEFT JOIN
		 sku bom_sku on sb.sku_code = bom_sku.sku_code
		 LEFT JOIN `USER` pui_crt ON sb.CREATOR = pui_crt.id
    </sql>


    <select id="selectByPrimaryKey" resultMap="skuBomResult" parameterType="java.lang.String" >
        SELECT 
        <include refid="baseSelect" />
        WHERE sb.sku_code=#{sku_code}
    </select>

    <update id="updateByPrimaryKey" parameterType="com.htf.entity.Sku">
        update SKU
        <set>
            <if test="name != null">
                NAME = #{name,jdbcType=VARCHAR},
            </if>
            <if test="comment != null">
                COMMENT = #{comment,jdbcType=VARCHAR},
            </if>
            <if test="piffer != null">
                PIFFER = #{piffer,jdbcType=VARCHAR},
            </if>
            <if test="pictures != null">
                PICTURES = #{pictures,jdbcType=VARCHAR},
            </if>
            <if test="modifierId != null">
                MODIFIER = #{modifierId,jdbcType=TINYINT},
            </if>
            <if test="level3CatId != null">
                CATEGORY = #{level3CatId,jdbcType=TINYINT},
            </if>
            MODIFY_TIME = SYSDATE()
        </set>
        where sku_code = #{skuCode,jdbcType=VARCHAR}
    </update>
    <insert id="insert" parameterType="com.htf.entity.Sku">
        INSERT INTO sku (`sku_code`, `name`, `status`, `bom_status`, `HAS_BOM_STATUS`,
   		`comment`, `pictures`, `create_time`, `creator`, `modify_time`, `modifier`, `piffer`,`category`
   		 )
   		VALUES (#{skuCode}, #{name}, 1, -1,
   		#{hasBom}, #{comment}, #{pictures}, SYSDATE() , #{creatorId}, #{modifyTime}, #{modifierId},
   		#{piffer}, #{level3CatId})
    </insert>
    <delete id="deleteByPrimaryKey">
        DELETE  FROM SKU WHERE sku_code = #{code,jdbcType=VARCHAR}
    </delete>
    <select id="selectByName"  resultType="com.htf.entity.Sku">
        SELECT
        <include refid="Base_Column_List" />
        FROM sku WHERE name = #{name,jdbcType=VARCHAR}
    </select>
    <insert id="batchInsert">
        insert into sku_bom(`sku_code`, `bom_sku_code`,  `qty`, `QTY_DENOMINATOR`,
        `WASTE_RATE`, `is_deleted_record`, `COMMENT`, `sku_version`, `CREATE_DATE`, `CREATOR`)
        VALUES
        <foreach collection="items" item="item" separator=",">
            (#{uniformSkuCode}, #{item.skuCode},  #{item.qty},
            #{item.qtyDenominator}, #{item.wasteRate}, false, #{item.comment}, #{uniformSkuVersion},
            #{uniformCrtTime}, #{uniformCreator})
        </foreach>
    </insert>
    <delete id="delBomBySkuCode">
        DELETE FROM sku_bom WHERE sku_code = #{skuCode}
    </delete>
</mapper>